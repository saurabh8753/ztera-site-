<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">

<title>ZTERA ‚Äì TeraBox Inline Player</title>
<meta name="theme-color" content="#3248f5">

<!-- HLS.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
body{
  margin:0;
  font-family:Inter,system-ui;
  background:#eef3ff
}
.wrap{
  max-width:980px;
  margin:30px auto;
  padding:16px
}
.hero{text-align:center}
h1{color:#3248f5;font-size:38px}

.card{
  background:#fff;
  padding:22px;
  border-radius:20px
}

input{
  width:100%;
  padding:14px;
  border-radius:14px;
  border:1px solid #ccc;
  font-size:16px
}

.btn{
  margin-top:16px;
  padding:14px;
  border-radius:16px;
  background:#4f46e5;
  color:#fff;
  font-size:18px;
  font-weight:700;
  border:0;
  width:100%;
  cursor:pointer
}

.loading{
  margin-top:14px;
  text-align:center;
  font-weight:700;
  color:#3248f5;
  display:none
}

.error{
  margin-top:10px;
  color:#dc2626;
  font-weight:700;
  text-align:center;
  display:none
}

.player{
  margin-top:22px;
  display:none
}

video{
  width:100%;
  max-height:70vh;
  background:#000;
  border-radius:16px
}
</style>
</head>

<body>

<div class="wrap">

<header class="hero">
  <h1>ZTERA ‚Äì Inline Video Player</h1>
  <p>Auto-retry enabled ‚Ä¢ No popup ‚Ä¢ No download</p>
</header>

<section class="card">

  <input id="tbxUrl" placeholder="Paste Terabox link here">

  <button class="btn" onclick="start()">‚ñ∂ Play Video</button>

  <div id="loading" class="loading">‚è≥ Fetching video‚Ä¶ please wait</div>
  <div id="error" class="error"></div>

  <div id="player" class="player">
    <video id="video" controls playsinline preload="auto"></video>
  </div>

</section>

</div>

<script>
const API = "https://iteraplay.in/api/fetch?url=";

let hls = null;
let retryTimer = null;
let stopped = false;

/* üöÄ START */
function start(){
  const link = tbxUrl.value.trim();
  if(link.length < 10){
    showError("Invalid TeraBox link");
    return;
  }

  stopped = false;
  error.style.display = "none";
  player.style.display = "none";
  loading.style.display = "block";

  fetchUntilSuccess(link);
}

/* üîÅ INFINITE AUTO RETRY */
async function fetchUntilSuccess(link){
  if(stopped) return;

  try{
    const controller = new AbortController();
    setTimeout(()=>controller.abort(), 10000);

    const res = await fetch(
      API + encodeURIComponent(link),
      { cache:"no-store", signal: controller.signal }
    );

    if(!res.ok) throw new Error();
    const data = await res.json();
    if(data.status !== "success") throw new Error();

    const file = data.list[0];

    const stream =
      file.fast_stream_url?.["720p"] ||
      file.fast_stream_url?.["360p"] ||
      file.stream_url;

    playInline(stream);

    loading.style.display = "none";
    player.style.display = "block";
    stopped = true;
    return;

  }catch(e){
    error.textContent = "Server busy‚Ä¶ retrying automatically";
    error.style.display = "block";

    retryTimer = setTimeout(()=>{
      fetchUntilSuccess(link);
    }, 2500);
  }
}

/* ‚ñ∂ INLINE PLAY */
function playInline(url){
  if(hls){
    hls.destroy();
    hls = null;
  }

  if(url.includes(".m3u8")){
    if(video.canPlayType("application/vnd.apple.mpegurl")){
      video.src = url;
    }else if(Hls.isSupported()){
      hls = new Hls();
      hls.loadSource(url);
      hls.attachMedia(video);
    }
  }else{
    video.src = url;
  }

  video.load();
  video.play().catch(()=>{});
}

function showError(msg){
  error.textContent = msg;
  error.style.display = "block";
}
</script>

<!-- ‚≠ê TELEGRAM BOT ‚Üí AUTO PLAY (URL PARAM: ?url=) -->
<script>
(function () {
  const params = new URLSearchParams(window.location.search);
  const botUrl = params.get("url");

  if (botUrl && botUrl.length > 10) {
    const input = document.getElementById("tbxUrl");

    if (input) {
      input.value = decodeURIComponent(botUrl);

      // Auto play after small delay
      setTimeout(() => {
        start();   // üëà matches this page's play function
      }, 1200);
    }
  }
})();
</script>

</body>
</html>
